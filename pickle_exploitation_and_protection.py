'''
Object Serialization with Pickle

Programs work with data in different representations:

1) In memory (inside a running program)
   - Data exists as Python objects (lists, dictionaries, class instances, etc.)
2) Stored in a file or sent over a network
   - Data must be converted into a self-contained sequence of bytes

# What is Pickle?
- Serialization (`pickle.dumps`, `pickle.dump`)
- Deserialization (`pickle.loads`, `pickle.load`)
- Used for saving Python objects to files or sending over networks
- Not safe for untrusted data
'''

import pickle
import hmac
import hashlib

# =====================================================
# PART 1: NORMAL PICKLE USAGE (SAFE, TRUSTED DATA)
# =====================================================

# Initializing data to be serialized
omkar = {'key': 'Omkar', 'name': 'Omkar Pathak', 'age': 21, 'pay': 40000}
jagdish = {'key': 'Jagdish', 'name': 'Jagdish Pathak', 'age': 50, 'pay': 50000}

# Creating an in-memory "database"
db = {
    'Omkar': omkar,
    'Jagdish': jagdish
}

# Serialize to bytes
serialized_bytes = pickle.dumps(db)

# Deserialize from bytes
restored_db = pickle.loads(serialized_bytes)

print("=== Normal Pickle Example ===")
print(restored_db)


# =====================================================
# PART 2: HOW PICKLE CAN BE EXPLOITED (DANGEROUS)
# =====================================================

class MaliciousPayload:
    """
    This class demonstrates how pickle can execute code
    during unpickling using the __reduce__ method.
    """
    def __reduce__(self):
        return (eval, ("print('üö® Malicious code executed during unpickling!')",))

print("\n=== Pickle Exploit Example ===")

# Attacker creates malicious pickle data
malicious_data = pickle.dumps(MaliciousPayload())

# Victim unpickles untrusted data
pickle.loads(malicious_data)


# =====================================================
# PART 3: SECURING PICKLE WITH HMAC (INTEGRITY CHECK)
# =====================================================

"""
If you trust the sender but NOT the storage or network,
you can protect pickled data using a cryptographic signature (HMAC).

This ensures the data has not been tampered with.
"""

SECRET_KEY = b"your_secret_key_here"  # Store securely in real applications

# Sender side
safe_data = pickle.dumps(db)
digest = hmac.new(SECRET_KEY, safe_data, hashlib.sha256).hexdigest()

print("\n=== Secured Pickle Example ===")

# Receiver side
expected_digest = hmac.new(SECRET_KEY, safe_data, hashlib.sha256).hexdigest()

if expected_digest != digest:
    print("‚ùå Data integrity violated")
else:
    unpickled = pickle.loads(safe_data)
    print("‚úÖ Data verified and safely unpickled:")
    print(unpickled)


# =====================================================
# FINAL NOTES
# =====================================================

"""
‚úî Pickle is powerful and convenient
‚ùå Pickle is NOT safe for untrusted input
‚úî Never unpickle user-provided data
‚úî Use JSON for untrusted data
‚úî Use HMAC when integrity matters between trusted systems
"""
